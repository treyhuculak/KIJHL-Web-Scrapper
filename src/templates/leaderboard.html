<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZebraZone - Officials Statistics</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='zebrazone-logo-badge.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script>
        // Extract league from URL and set dynamic CSS variables BEFORE page renders
        // Declare as global variable for use throughout the page
        const urlParams = new URLSearchParams(window.location.search);
        var currentLeague = urlParams.get('league') || 'kijhl';
        
        // Define color schemes for each league
        const leagueColors = {
            'kijhl': {
                primary: '#cc0000',    // Red
                secondary: '#1a1a1a',  // Black
                accent: '#ffffff',     // White
                name: 'KIJHL'
            },
            'whl': {
                primary: '#e06900',    // Orange
                secondary: '#1a1a1a',  // Black
                accent: '#ffffff',     // White
                name: 'WHL'
            }
        };
        
        // Get colors for current league or default to KIJHL
        const colors = leagueColors[currentLeague] || leagueColors['kijhl'];
        
        // Inject CSS variables dynamically
        document.documentElement.style.setProperty('--ref-red', colors.primary);
        document.documentElement.style.setProperty('--ref-black', colors.secondary);
        document.documentElement.style.setProperty('--ref-white', colors.accent);
    </script>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="header-logo-container">
                <img src="{{ url_for('static', filename='zebrazone-logo-badge.png') }}" alt="ZebraZone Logo" class="header-badge-logo">
                <img src="{{ url_for('static', filename=current_league + '-logo.png') }}" alt="League Logo" class="header-league-logo">
            </div>
            <h1>Officials Statistics</h1>
            <p>Search, filter and view officials in the <span id="leagueAbbr"></span>. Click on the name of the official for season-by-season details</p>
            <div style="display: flex; justify-content: center; gap: 15px; margin-top: 15px;">
                <a href="/" class="nav-link">‚Üê Back to League Selector</a>
                <a href="/games" class="nav-link">Game Centre ‚Üí</a>
            </div>
        </div>

        <button class="filter-toggle" style="display: none;">Show/Hide Filters</button>

        <!-- Search Bar -->
        <div class="search-container">
            <input type="text" id="officialSearch" class="search-input"
                placeholder="üîç Search for an official by name...">
        </div>

        <div class="filter-bar collapsible-filters"
            style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; border-left: 5px solid var(--ref-black);">
            <form id="filterForm" onsubmit="return false;"
                style="display: flex; gap: 10px; width: 100%; align-items: center; flex-wrap: wrap;">

                <div>
                    <label style="font-size: 0.8em; font-weight: bold; display: block;">OFFICIAL TYPE</label>
                    <select name="role" id="filterRole"
                        style="padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                        <option value="all">All Officials</option>
                        <option value="referee">Referees</option>
                        <option value="linesman">Linesmen</option>
                    </select>
                </div>


                <div>
                    <label style="font-size: 0.8em; font-weight: bold; display: block;">SEASON</label>
                    <select name="season" id="filterSeason"
                        style="padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                        <option value="66">2025-26 Playoffs</option>
                        <option value="65" selected>2025-26 Regular Season</option>
                        <option value="63">2024-25 Playoffs</option>
                        <option value="61">2024-25 Regular Season</option>
                        <option value="59">2023-24 Playoffs</option>
                        <option value="56">2023-24 Regular Season</option>
                        <option value="54">2022-23 Playoffs</option>
                        <option value="52">2022-23 Regular Season</option>
                        <option value="51">2021-22 Playoffs</option>
                        <option value="49">2021-22 Regular Season</option>
                    </select>
                </div>

                <div>
                    <label style="font-size: 0.8em; font-weight: bold; display: block;">MIN. GAMES</label>
                    <input type="number" name="games_called" id="filterMinGames" min="0" value="0"
                        style="width: 60px; padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                </div>

                <div style="margin-left: auto;">
                    <button type="button" onclick="applyFilters()"
                        style="padding: 10px 20px; background: var(--ref-red); color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">APPLY
                        FILTERS</button>
                </div>
            </form>
        </div>

        <div class="table-card">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Official</th>
                        <th>Role</th>
                        <th class="sortable" onclick="sortTable('games')">
                            <a href="javascript:void(0);">
                                Games Called
                                <span class="sort-indicator" id="sort-games">
                                    <span class="dir-up">‚ñ≤</span><span class="dir-down active">‚ñº</span>
                                </span>
                            </a>
                        </th>
                        <th class="sortable" onclick="sortTable('pims')">
                            <a href="javascript:void(0);">
                                Total PIMs
                                <span class="sort-indicator" id="sort-pims">
                                    <span class="dir-up">‚ñ≤</span><span class="dir-down">‚ñº</span>
                                </span>
                            </a>
                        </th>
                        <th class="sortable" onclick="sortTable('avg')">
                            <a href="javascript:void(0);">
                                Avg PIMs/Game
                                <span class="sort-indicator" id="sort-avg">
                                    <span class="dir-up">‚ñ≤</span><span class="dir-down">‚ñº</span>
                                </span>
                            </a>
                        </th>
                    </tr>
                </thead>
                <tbody id="officialsTableBody">
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px;">
                            Loading officials data...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Hockey Card Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="hockey-card" id="hockeyCard">
            <div class="card-header">
                <button class="card-close" onclick="closeModal()">&times;</button>
                <div class="profile-picture">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                    </svg>
                </div>
                <h2 class="card-name" id="cardName">Loading...</h2>
                <div class="card-role" id="cardRole"></div>
            </div>
            <div class="card-body">
                <div id="cardContent">
                    <div class="loading-spinner">Loading career stats...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Insert correct league name into description
        document.getElementById('leagueAbbr').textContent = currentLeague.toUpperCase();

        // ===== CLIENT-SIDE DATA MANAGEMENT =====
        // All officials data is stored in memory to minimize database reads
        let allOfficialsData = [];
        // currentLeague is already defined globally in the <head> section
        let currentFilters = {
            role: 'all',
            minGames: 0,
            season: '65',
            sort: 'games',
            order: 'desc'
        };

        // Load officials data from API on page load
        async function loadOfficialsData(season, league) {
            try {
                const response = await fetch(`/api/officials?season=${season}&league=${league}`);
                const data = await response.json();

                allOfficialsData = data.officials;
                console.log(`Loaded ${allOfficialsData.length} officials for ${league.toUpperCase()} season ${season}`);

                // Apply initial display
                applyFilters();
            } catch (error) {
                console.error('Error loading officials data:', error);
                document.getElementById('officialsTableBody').innerHTML =
                    '<tr><td colspan="6" style="text-align: center; padding: 40px; color: red;">Error loading data. Please refresh.</td></tr>';
            }
        }

        // Apply filters and sorting, then render table
        function applyFilters() {
            // Get current filter values
            currentFilters.role = document.getElementById('filterRole').value;
            currentFilters.minGames = parseInt(document.getElementById('filterMinGames').value) || 0;
            currentFilters.season = document.getElementById('filterSeason').value;

            // Check if season changed - need to reload data
            const previousSeason = allOfficialsData.length > 0 ? allOfficialsData[0].season_id : null;
            if (previousSeason && previousSeason != currentFilters.season) {
                loadOfficialsData(currentFilters.season, currentLeague);
                return;
            }

            // Filter the data
            let filtered = allOfficialsData.filter(official => {
                // Role filter
                if (currentFilters.role !== 'all' && official.role !== currentFilters.role) {
                    return false;
                }

                // Min games filter
                if (official.games_called < currentFilters.minGames) {
                    return false;
                }

                // Search filter (from search box)
                const searchTerm = document.getElementById('officialSearch').value.toLowerCase();
                if (searchTerm && !official.name.toLowerCase().includes(searchTerm)) {
                    return false;
                }

                return true;
            });

            // Sort the data
            sortData(filtered);

            // Render the table
            renderTable(filtered);
        }

        // Sort data based on current sort settings
        function sortData(data) {
            const sortField = currentFilters.sort;
            const order = currentFilters.order;

            data.sort((a, b) => {
                let aVal, bVal;

                if (sortField === 'games') {
                    aVal = a.games_called || 0;
                    bVal = b.games_called || 0;
                } else if (sortField === 'pims') {
                    aVal = a.total_pims || 0;
                    bVal = b.total_pims || 0;
                } else if (sortField === 'avg') {
                    aVal = a.avg_pims || 0;
                    bVal = b.avg_pims || 0;
                }

                if (order === 'desc') {
                    return bVal - aVal;
                } else {
                    return aVal - bVal;
                }
            });
        }

        // Render the table with filtered/sorted data
        function renderTable(officials) {
            const tbody = document.getElementById('officialsTableBody');

            if (officials.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">No officials match the current filters.</td></tr>';
                return;
            }

            let html = '';
            officials.forEach((official, index) => {
                html += `
                    <tr>
                        <td class="rank">${index + 1}</td>
                        <td class="name">
                            <span class="name-link" onclick="openOfficialCard('${official.name}', '${official.role}')">
                                ${official.name}
                            </span>
                        </td>
                        <td>
                            <span class="role-badge role-${official.role}">
                                ${official.role}
                            </span>
                        </td>
                        <td>${official.games_called}</td>
                        <td class="stat-val stat-high">${official.total_pims}</td>
                        <td class="stat-val">${official.avg_pims}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // Handle column sorting clicks
        function sortTable(column) {
            // Toggle order if clicking same column
            if (currentFilters.sort === column) {
                currentFilters.order = currentFilters.order === 'desc' ? 'asc' : 'desc';
            } else {
                currentFilters.sort = column;
                currentFilters.order = 'desc'; // Default to descending for new column
            }

            // Update sort indicators
            updateSortIndicators();

            // Re-apply filters and render
            applyFilters();
        }

        // Update visual sort indicators
        function updateSortIndicators() {
            // Clear all active states
            document.querySelectorAll('.sort-indicator span').forEach(el => {
                el.classList.remove('active');
            });

            // Set active state for current sort
            const indicator = document.getElementById(`sort-${currentFilters.sort}`);
            if (indicator) {
                const arrow = currentFilters.order === 'asc' ?
                    indicator.querySelector('.dir-up') :
                    indicator.querySelector('.dir-down');
                if (arrow) arrow.classList.add('active');
            }
        }

        // --- Official Search Functionality ---
        document.getElementById('officialSearch').addEventListener('input', function (e) {
            // Search is now handled in applyFilters()
            applyFilters();
        });

        // --- Modal Functions ---
        function openOfficialCard(name, role) {
            const modal = document.getElementById('modalOverlay');
            const hockeyCard = document.getElementById('hockeyCard');
            const cardName = document.getElementById('cardName');
            const cardRole = document.getElementById('cardRole');
            const cardContent = document.getElementById('cardContent');

            // Apply role-based styling
            hockeyCard.classList.remove('linesman', 'referee');
            hockeyCard.classList.add(role);

            // Show modal with loading state
            modal.classList.add('active');
            // Prevent background scrolling
            document.body.style.overflow = 'hidden';

            cardName.textContent = name;
            cardRole.textContent = role;
            cardContent.innerHTML = '<div class="loading-spinner">Loading career stats...</div>';

            // Fetch career stats with league parameter
            fetch(`/api/official/${encodeURIComponent(name)}?league=${currentLeague}`)
                .then(response => response.json())
                .then(data => {
                    renderCardContent(data);
                })
                .catch(error => {
                    cardContent.innerHTML = '<div class="loading-spinner">Error loading stats</div>';
                    console.error('Error:', error);
                });
        }

        function renderCardContent(data) {
            const cardContent = document.getElementById('cardContent');

            if (!data.seasons || data.seasons.length === 0) {
                cardContent.innerHTML = '<div class="loading-spinner">No career data available</div>';
                return;
            }

            // Separate regular season and playoff seasons
            const regularSeasons = data.seasons.filter(s => !s.season_name.includes('Playoff'));
            const playoffSeasons = data.seasons.filter(s => s.season_name.includes('Playoff'));

            // Calculate separate totals
            const regTotals = calculateTotals(regularSeasons);
            const playoffTotals = calculateTotals(playoffSeasons);

            let html = '';

            // Regular Season Section
            if (regularSeasons.length > 0) {
                html += buildSection('Regular Season', regularSeasons, regTotals, false);
            }

            // Divider between sections
            if (regularSeasons.length > 0 && playoffSeasons.length > 0) {
                html += '<hr class="section-divider">';
            }

            // Playoffs Section
            if (playoffSeasons.length > 0) {
                html += buildSection('Playoffs', playoffSeasons, playoffTotals, true);
            }

            cardContent.innerHTML = html;
        }

        function calculateTotals(seasons) {
            const totalGames = seasons.reduce((sum, s) => sum + (s.games_called || 0), 0);
            const totalPims = seasons.reduce((sum, s) => sum + (s.total_pims || 0), 0);
            const avgPims = totalGames > 0 ? (totalPims / totalGames).toFixed(1) : 0;
            return { games: totalGames, pims: totalPims, avg: avgPims, count: seasons.length };
        }

        function buildSection(title, seasons, totals, isFinal) {
            let html = `
                <div class="stats-section">
                    <div class="seasons-title">${title}</div>
                    <div class="stats-header">
                        <span class="stats-header-season">Season</span>
                        <div class="stats-header-cols">
                            <span class="stats-header-col">GP</span>
                            <span class="stats-header-col">PIMs</span>
                            <span class="stats-header-col">AVG</span>
                        </div>
                    </div>
            `;

            seasons.forEach(season => {
                // Clean up season name for display
                const displayName = season.season_name.replace(' Regular Season', '').replace(' Playoffs', '');
                html += `
                    <div class="season-row">
                        <span class="season-name">${displayName}</span>
                        <div class="season-stats">
                            <span class="season-stat">${season.games_called}</span>
                            <span class="season-stat">${season.total_pims}</span>
                            <span class="season-stat">${season.avg_pims}</span>
                        </div>
                    </div>
                `;
            });

            html += `
                </div>
                <div class="career-totals ${isFinal ? 'final' : ''}">
                    <div class="career-row">
                        <span class="career-label">${title == 'Playoffs' ? 'Playoff Totals' : seasons.length + ' KIJHL Seasons'}</span>
                        <div class="career-stats">
                            <span class="career-stat">
                                <div class="career-stat-value">${totals.games}</div>
                            </span>
                            <span class="career-stat">
                                <div class="career-stat-value">${totals.pims}</div>
                            </span>
                            <span class="career-stat">
                                <div class="career-stat-value">${totals.avg}</div>
                            </span>
                        </div>
                    </div>
                </div>
            `;

            return html;
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
            // Restore background scrolling
            document.body.style.overflow = '';
        }

        // Close modal when clicking outside the card
        document.getElementById('modalOverlay').addEventListener('click', function (e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        document.addEventListener('DOMContentLoaded', function () {
            // --- Responsive Filters ---
            const filterToggle = document.querySelector('.filter-toggle');
            const collapsibleFilters = document.querySelector('.collapsible-filters');

            function toggleFiltersBasedOnWidth() {
                if (window.innerWidth <= 768) {
                    filterToggle.style.display = 'block';
                    collapsibleFilters.style.display = collapsibleFilters.classList.contains('open') ? 'flex' : 'none';
                } else {
                    filterToggle.style.display = 'none';
                    collapsibleFilters.style.display = 'flex';
                }
            }

            filterToggle.addEventListener('click', function () {
                collapsibleFilters.classList.toggle('open');
                if (collapsibleFilters.style.display === 'none') {
                    collapsibleFilters.style.display = 'flex';
                } else {
                    collapsibleFilters.style.display = 'none';
                }
            });

            window.addEventListener('resize', toggleFiltersBasedOnWidth);
            toggleFiltersBasedOnWidth(); // Initial check

            // --- Initialize Data Loading ---
            // Extract league and season from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            // currentLeague is already set at script initialization
            const selectedSeason = urlParams.get('season') || '{{ current_season }}' || '65';
            
            // Update the page title to show league name
            const leagueColors = {
                'kijhl': { name: 'KIJHL' },
                'whl': { name: 'WHL' }
            };
            const leagueName = leagueColors[currentLeague]?.name || currentLeague.toUpperCase();
            document.getElementById('leagueAbbr').textContent = leagueName;
            
            // Set the selected season in the dropdown
            document.getElementById('filterSeason').value = selectedSeason;
            currentFilters.season = selectedSeason;

            // Load officials data for the selected season and league
            loadOfficialsData(selectedSeason, currentLeague);

            // Update sort indicators to match default sort
            updateSortIndicators();
        });

    </script>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="footer-content">
            <div class="footer-section">
                <h4>Quick Links</h4>
                <a href="/">Home</a>
                <a href="/games">Game Centre</a>
                <a href="/statistics">Officials Stats</a>
            </div>
            <div class="footer-section">
                <h4>About</h4>
                <a href="/about">About ZebraZone</a>
            </div>
            <div class="footer-section footer-branding">
                <img src="{{ url_for('static', filename='zebrazone-logo-badge.png') }}" alt="ZebraZone" class="footer-logo">
                <p>2026 ZebraZone</p>
                <p class="footer-tagline">Making hockey officiating data accessible</p>
            </div>
        </div>
    </footer>
</body>

</html>